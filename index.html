<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<script type="text/javascript" src='js/lib/three.js'></script>
		<script type="text/javascript" src='js/lib/three.obj-loader.js'></script>
		<script type="text/javascript" src='js/lib/three.first-person-controls.js'></script>
	    <script type="text/javascript" src="js/lib/underscore-min.js"></script>
		<style type="text/css">
			body {
				margin:0;
				padding: 0;
			}
			#loading {
				background: url(img/cover.jpg) no-repeat center center fixed; 
				-webkit-background-size: cover;
				-moz-background-size: cover;
				-o-background-size: cover;
				background-size: cover;
				color: #ffffff;
				font-family: 'brandon-grotesque','helvetica','arial',sans-serif;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				top: 0;
				text-align: center;
			}
			#loading  img {
				padding: 60px 0 30px;
			}
		</style>
	</head>
	<body>

		<div id='loading'>
			<img src="img/ilustratie.png" width='200'/>
			<h2>Se încarcă oraşul 3D. Vă rugăm să aşteptați.</h2>
		</div>

		<script type='text/javascript'>

			var container, stats;

			var camera, scene, renderer;

			var mouseX = 0, mouseY = 0, mouseBtn = -1;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;


			init();
			animate();


			function init() {

				container = document.createElement( 'div' );
				container.style.backgroundColor = '#000000';

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.01, 45 );
				camera.position.z = 10;
				camera.position.y = 10;
        controls =  new THREE.FirstPersonControls(camera, scene);
        controls.movementSpeed = .002;
        controls.lookSpeed = 0.00007;
        controls.lookVertical = true; 

				// scene

				scene = new THREE.Scene();

				var ambient = new THREE.AmbientLight( 0x111111 );
				scene.add( ambient );

				var directionalLight = new THREE.DirectionalLight( 0xffeedd );
				directionalLight.position.set( 1, 1, 1 );
				scene.add( directionalLight );

				// scene.fog = new THREE.FogExp2(0x000000, .1);
				// texture

				var manager = new THREE.LoadingManager(function() {
					scene.add( mesh );
				});

				var texture = new THREE.Texture();

				var objects = [];
        /*
				objects.push('A1');
				objects.push('A2');
				objects.push('A3');
				objects.push('A4');
				objects.push('A5');
				objects.push('B1');
				objects.push('B2');
				objects.push('B3');
				objects.push('B4');
				objects.push('B5');
				objects.push('C1');
				objects.push('C2');
				objects.push('C3');
				objects.push('C4');
				objects.push('C5');
				// objects.push('D1');
				// objects.push('D2');
				// objects.push('D3');
				// objects.push('D4');
				// objects.push('D5');
				objects.push('E1');
				objects.push('E2');
				objects.push('E3');
				objects.push('E4');
				objects.push('F1');
				objects.push('F2');
				objects.push('F3');
				objects.push('F4');
				objects.push('F5');

        /*
				var f1_matrix = new THREE.Matrix4();
				f1_matrix.makeTranslation(0.97, 1.21, 4.85);
				// f1_matrix.makeRotationY(Math.PI);

				var f2_matrix = new THREE.Matrix4();
				f2_matrix.makeTranslation(0.97, 1.21, 4.85);
				// f2_matrix.makeRotationY(Math.PI);
				
				var f3_matrix = new THREE.Matrix4();
				f3_matrix.makeTranslation(0.97, 1.21, 4.85);
				// f3_matrix.makeRotationY(Math.PI);

				var f4_matrix = new THREE.Matrix4();
				f4_matrix.makeTranslation(0.97, 1.21, 4.85);
				// f4_matrix.makeRotationY(Math.PI);

				var f5_matrix = new THREE.Matrix4();
				f5_matrix.makeTranslation(0.97, 1.21, 4.85);
				// f5_matrix.makeRotationY(Math.PI);


				var a_matrix = new THREE.Matrix4();
				a_matrix.makeScale(10, 10, 10);

        var d_matrix = new THREE.Matrix4();
        d_matrix.makeTranslation(0, 1, -46);
        d_matrix.makeScale(2.5, 2.5, 2.5);
				var transforms = {
					'A2': a_matrix,
					'A3': a_matrix,
					'A4': a_matrix,
					'A5': a_matrix,
					'B2': a_matrix,
					'B3': a_matrix,
					'B4': a_matrix,
					'B5': a_matrix,
					'C2': a_matrix,
					'C3': a_matrix,
					'C4': a_matrix,
					'C5': a_matrix,
					'F1': f1_matrix,
					'F2': f2_matrix,
					'F3': f3_matrix,
					'F4': f4_matrix,
					'F5': f5_matrix
				};

*/
        objects.push('cluj');
				var geo = new THREE.Geometry();
        var earth = new THREE.CubeGeometry(1000, 0.00001, 1000);
        var earth_matrix = new THREE.Matrix4();
        earth_matrix.makeTranslation(0, -0.61, 0);
        earth.applyMatrix(earth_matrix);
        THREE.GeometryUtils.merge(geo, earth);
				var material = new THREE.MeshLambertMaterial();

        var i =0;
				objects.forEach(function(name) {


					var loader = new THREE.OBJLoader( manager );
					loader.load( 'obj/' + name + '.obj', function ( object ) {

//					if (transforms[name]) object.applyMatrix(transforms[name]);
//					object.updateMatrix();
//					object.updateMatrixWorld();


            object.traverse(function(child){
              /*
                if(child.parent){
                    child.updateMatrixWorld();
                    child.applyMatrix(child.parent.matrixWorld);    
                }
               */

                if (child instanceof THREE.Mesh) {
                  i++;
                  THREE.GeometryUtils.merge(geo, child);
                }
            });

            console.log('objects', i);
          });
				});

        var mesh = new THREE.Mesh( geo, material );

				renderer = new THREE.WebGLRenderer( { antialias: false, alpha: false } );
				renderer.setClearColor( 0xd8e7ff );
				renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.domElement.style.padding = 0;
        renderer.domElement.style.margin = 0;

				document.body.appendChild( container );
				container.appendChild( renderer.domElement );
        window.addEventListener( 'resize', onWindowResize, false );

        lastTime = performance.now();
        camera.lookAt(scene.position);
        removeLoading();
			}

      function render() {
        var time = performance.now();
        controls.update(time - lastTime);
        renderer.render( scene, camera );
        lastTime = time;

      }
      
			function animate() {
        render();
        requestAnimationFrame( animate );

			}

     function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
     }

			function removeLoading() {
				var loading = document.getElementById('loading');
				document.body.removeChild(loading);
			}

		</script>
	</body>
</html>
